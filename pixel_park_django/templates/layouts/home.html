<!DOCTYPE html>
<html>
<head>
	<title>{% block title %}{% endblock %}</title>
    {% load static %}
	<!-- Bootstrap -->

	<link rel="stylesheet" type="text/css" href="{% static 'assets/css/bootstrap.min.css' %}">

	<!-- Font Awesome -->
	<link rel="stylesheet" type="text/css" href="{% static 'assets/css/fa-all.css' %}">
	<!-- cssGram -->

	<link rel="stylesheet" type="text/css" href="{% static 'assets/css/cssgram.min.css' %}">

	<!-- Core Css -->
	<link rel="stylesheet" type="text/css" href="{% static 'assets/css/fe.css' %}">

	<!-- Jquery 3.4 -->
	<script type="text/javascript" src="{% static 'assets/js/jquery-3.4.1.slim.min.js' %}"></script>
	<style type="text/css">

	</style>
</head>
<body>
{% block modal %}{% endblock %}
	<!-- Modal for render-->
	<div class="modal modal-render" tabindex="-1" role="dialog">
	  <div class="modal-dialog modal-xl" role="document">
		<div class="modal-content">
		  <div class="modal-header" style="border-bottom: none;" >
			 <h5 class="modal-title"></h5>
			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true">&times;</span>
			</button>
		  </div>
		  <div class="modal-body modal-body-render">

		  </div>
		</div>
	  </div>
	</div>
	<!-- modal end -->

	<!-- media modal -->
	<div class="modal fade modal-media" tabindex="-1" role="dialog" >
	  <div class="modal-dialog modal-md" role="document">
	    <div class="modal-content h-100">
	      <div class="modal-header">
	        <h5 class="modal-title-follow modal-title">Camera/Upload</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body-follow modal-body d-flex align-items-center justify-content-center">
	      	<div class=" p-5">
	      		<input type="file" id="photoUp" style="display: none" />
	      		<a id="upload-link" onclick="document.getElementById('photoUp').click()" class="media-link"><button class="btn-primary btn"><i class="fas fa-plus"></i></button></a>

	      		<a id="camera-link" class="media-link"><button class="btn-success btn"><i class="fas fa-camera"></i></button></a>
	      	</div>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- end modal -->

	<!-- camera modal -->
	<div class="modal fade modal-camera" tabindex="-1" role="dialog" >
	  <div class="modal-dialog modal-md h-auto" role="document">

	  <!-- <div class="modal-dialog modal-xl h-100" role="document" style="max-height: calc(100vh - 143px);"> -->
	    <div class="modal-content h-50">
	      <div class="modal-header">
	        <h5 class="modal-title-follow modal-title">Camera</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body-follow h-100 modal-body">
	      	<div class="h-100">
	      		<div class="d-block">
		      			<video id="video" class="w-100 rounded" autoplay></video>
<!--
						<canvas id="canvas" class="w-100"></canvas>	 -->
	      		</div>
	      		<div class="d-block">
	      			<div class="row">
	      				<div class="col">
							<button id="snap" class="btn btn-success w-100"><i class="fas fa-camera"></i></button>
						</div>
						<div class="col">
							<button class="btn btn-warning w-100" data-dismiss="modal"><i class="fas fa-times"></i></button>
						</div>
	      			</div>
	      		</div>

	      		<!-- <a class="media-link"><button class="btn-primary btn"><i class="fas fa-camera"></i></button></a> -->
	      	</div>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- end modal -->


	<!-- photo modal -->
	<div class="modal fade modal-photo h-auto" tabindex="-1" role="dialog" >
	  <div class="modal-dialog modal-dialog-scrollable modal-md h-50" role="document">

	  <!-- <div class="modal-dialog modal-xl h-100" role="document" style="max-height: calc(100vh - 143px);"> -->
	    <div class="modal-content h-100">
	      <div class="modal-header">
	        <h5 class="modal-title-follow modal-title">Save?</h5>
	        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
	          <span aria-hidden="true">&times;</span>
	        </button>
	      </div>
	      <div class="modal-body-follow modal-body">
	      	<div class="h-100">
	      		<div class="d-block">
					<canvas id="canvas" class="rounded"></canvas>

				</div>
				<div class="d-block">
					<div class="render-effects carousel effect-1" data-ride="carousel" data-interval="false">
						<ol class="carousel-indicators render-carousel">
						</ol>
						<a class="carousel-control-prev" href=".effect-1" role="button" data-slide="prev">
						    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
						    <span class="sr-only">Previous</span>
						  </a>
						  <a class="carousel-control-next" href=".effect-1" role="button" data-slide="next">
						    <span class="carousel-control-next-icon" aria-hidden="true"></span>
						    <span class="sr-only">Next</span>
						  </a>
						  <div class="carousel-inner carousel-inner-render justify-content-center align-items-center d-flex">
						  </div>
					</div>
				</div>
				<div class="d-block mb-2">
	      			<div class="row">
	      				<div class="col-md-12">
	      					<form id="form-photo" action="/upload" enctype="multipart/form-data" method="post">
								{% csrf_token %}
	      						<div class="form-group my-2">
	      							<input type="text" class="form-control" name="caption" placeholder="Caption">
	      						</div>
								<input name="photo" type="text" hidden id="photo-input">
	      					</form>
	      				</div>
	      				<div class="col">
							<button id="photo-upload" class="btn btn-primary w-100"><i class="fas fa-upload" title="Upload"></i></button>
						</div>
						<div class="col">
							<button class="btn btn-danger w-100 back-to-camera" ><i class="fas fa-camera" title="Back to camera"></i></button>
						</div>
	      			</div>
	      		</div>
	      	</div>
	      </div>
	    </div>
	  </div>
	</div>
	<!-- end photo modal -->

	<div class="container-fluid bg-light">
		<!-- Full screen nav -->
		<nav class="big-nav navbar sticky-top row navbar-light bg-light" style="border-bottom: 1px solid #e5e5e5">

			<div class="px-5 w-auto row">
				<div class="col-sm-4 px-0 ">
					<a class="navbar-brand text-left"  href="/index">PixelPark</a>
				</div>

				<!--search bar-->
				<div class="col-sm-4 px-0 text-center dropdown" id="search-bar">
					<form class="form-inline my-2 my-lg-0 px-3 h-20 ">
				      	<input class="form-control mr-sm-2 w-100 text-center rounded" id="nav-search" type="search" placeholder="Search" aria-label="Search">

						<div id="nav-search-dropdown" class="dropdown-menu dropdown-search w-100 p-0">

						</div>
				      	<!-- <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button> -->
				    </form>
				</div>
				<div class="col-sm-4 px-0 text-right i-frame-format">

					<span class="ml-3"><a href="#" id="nav-camera" class="px-10px icon-hover rounded"><i class="fas fa-camera-retro"></i></a></span>
					<span class="ml-3"><a href="#" class="px-10px icon-hover rounded"><i class="far fa-compass"></i></a></span>

					<!-- <a class="col nav-icon" href="#"><span><i class="fas fa-camera"></i></span></a> -->

					<!-- Notification -->
					<div id="notification-head" class="dropdown d-inline">
						<span class="ml-3"><a href="#" class="px-10px icon-hover rounded" id="nav-notification" class="notification"><i class="far fa-heart"></i></a></span>

					  	<div id="nav-notification-menu" class="dropdown-menu dropdown-notification w-100" aria-labelledby="dropdownMenuButton">

						</div>
					</div>

					<!-- profile -->
					<div id="profile-head" class="dropdown d-inline">

						<span class="ml-3"><a href="#" class="px-10px icon-hover rounded" id="nav-profile"><i class="far fa-user"></i></a></span>

					  	<div id="nav-profile-menu" class="dropdown-menu dropdown-notification w-100">
						    <div class="row px-2 py-2">
						    	<div class="col-md-12">
						    		<div class="h-100 d-flex justify-content-center align-items-center">
						    			<img class="rounded-circle icon-image-profile" src="/static/images/{{ user.image }}">
						    		</div>
						    	</div>
						    	<div class="col-md-12">
							    	<div class="col-md-12 notification-text">
							    		<div class="img-post-caption h-100  text-center">
		  									<p class="m-0 py-1"><a href="/profile/{{ user.id }}" class="p-0">@{{ user.username }}</a><br>
		  									{{ user.name }}</p>
		  								</div>
							    	</div>
						    	</div>


						    </div>
						    <div class="row px-2 py-0">
						    	<div class="col-md-6 notification-text no-border-bottom">
						    		<div class="h-100 w-100 ">
						    			<a href="#" class="w-100 profile-button"><button class="btn btn-secondary w-100">Edit Profile</button></a>
						    		</div>
						    	</div>

						    	<div class="col-md-6 notification-text no-border-bottom">
						    		<div class="h-100 w-100 ">
										<a href="/logout" class="w-100 profile-button"><button class="btn btn-primary w-100">Logout</button></a>
						    		</div>
					    		</div>
						    </div>

						</div>
					</div>


				</div>
			</div>

		</nav>
		<!-- full screen nav end -->

		<!-- mobile view nav -->
		<nav class="small-nav navbar sticky-top navbar-light bg-light" style="border-bottom: 1px solid #e5e5e5">

			<div class="w-auto row text-center i-frame-format">

					<a class="col nav-icon" href="#"><span><i class="fas fa-home"></i></span></a>

					<a class="col nav-icon" href="#"><span><i class="fas fa-search"></i></span></a>

					<a class="col nav-icon" href="#"><span><i class="fas fa-camera"></i></span></a>
					<!-- <a class="col nav-icon" href="#"><span><i class="fas fa-plus"></i></span></a> -->

					<a class="col nav-icon" href="#"><span><i class="fas fa-heart"></i></span></a>
					<a class="col nav-icon" href="#"><span><i class="fas fa-user"></i></span></a>

			</div>

		</nav>
		<!-- mobile view nav end -->

	  	<div class="row justify-content-center h-auto mx-2">
            {% block content %}{% endblock %}
       	</div>
	</div>



	<!-- Scripts -->
	<!-- Bootstrap js -->
	<script type="text/javascript" src="{% static 'assets/js/bootstrap.min.js' %}" ></script>

	<!-- Font awesome -->
	<script type="text/javascript" src="{% static 'assets/js/fa-all.js' %}" ></script>

	<!-- Pooper min -->
	<script type="text/javascript" src="{% static 'assets/js/popper.min.js' %}"></script>
	<script type="text/javascript">
		$('.carousel').carousel()
	</script>
	<script type="text/javascript">
		//  search

		$('#nav-search').on('focus',function(e){
			console.log('hi')
<!--			$('#nav-search-dropdown').show();-->
<!--			search($(this).val())-->
		})
		$('#nav-search').on('change keyup paste click',function(e){

			var search=$(this).val()
			$.ajax({
				url:'/profile/search',
				data:{search:search},
				dataType:'JSON',
				method:'GET',
				success:function(data){
					console.log(data.data)
					$('#nav-search-dropdown').html(data.data);
					$('#nav-search-dropdown').show();
				}

			})
		})

		function search(value){

		}

		// $('.modal-media').modal('show');
		$('.comment-icon').on('click',function (e){
			e.preventDefault();
			var id=$(this).attr('data-id');
			$('.post-1'+id).focus();
		});

		$('#nav-notification').on('click',function(e){
			e.preventDefault();
			$.ajax({
				url:'/profile/get-notification',
				dataType:'json',
				type:'get',
				success:function(data){

					$('#nav-notification-menu').toggle();
					$('#nav-notification-menu').html(data.html)
					$(this).addClass('icon-active');
				}
			})
		});

		$('#nav-camera').on('click',function(e){
			$('.modal-media').modal('show');
		});

		$('#camera-link').on('click',function(e){
			e.preventDefault();
			$('.modal-media').modal('hide');
			$('.modal-camera').modal('show');
		});

		$('#nav-profile').on('click',function(e){
			e.preventDefault();
			$(this).addClass('icon-active');
			$('#nav-profile-menu').toggle()
		});
		$('html').on('click',function(e) {
			if( !$(e.target).closest("#search-bar").length > 0 )
			{
				$('#search-bar #nav-search-dropdown').hide();
			}
		   	if( !$(e.target).closest("#notification-head").length > 0 ) {
		    	$('#notification-head #nav-notification-menu').hide();
		   		$('#nav-notification').removeClass('icon-active');
		    }

		    if( !$(e.target).closest("#profile-head").length > 0 ) {
		    	$('#profile-head #nav-profile-menu').hide();
		    	$('#nav-profile').removeClass('icon-active');
		    }
		});

		$('.back-to-camera').on('click',function(e){
			$('.modal').modal('hide');
			$('.modal-camera').modal('show');
		})
	</script>
	<script type="text/javascript">
		// Grab elements, create settings, etc.
		var video = document.getElementById('video');

		// Get access to the camera!
		if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
		    // Not adding `{ audio: true }` since we only want video now
		    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
		        //video.src = window.URL.createObjectURL(stream);
		        video.srcObject = stream;
		        video.play();
		    });
		}

		/* Legacy code below: getUserMedia
		else if(navigator.getUserMedia) { // Standard
		    navigator.getUserMedia({ video: true }, function(stream) {
		        video.src = stream;
		        video.play();
		    }, errBack);
		} else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
		    navigator.webkitGetUserMedia({ video: true }, function(stream){
		        video.src = window.webkitURL.createObjectURL(stream);
		        video.play();
		    }, errBack);
		} else if(navigator.mozGetUserMedia) { // Mozilla-prefixed
		    navigator.mozGetUserMedia({ video: true }, function(stream){
		        video.srcObject = stream;
		        video.play();
		    }, errBack);
		}
		*/

		// var effects=["_1977","aden","brannan","brooklyn","clarendon","earlybird","gingham","hudson","inkwell","kelvin","lark","lofi","maven","mayfair","moon","nashville","perpetua","reyes","rise","slumber","stinson","toaster","valencia","walden","willow","xpro2","nofilter"];

		var effects=["_1977","aden","brannan","inkwell","kelvin","lark","lofi","maven","mayfair","moon","nashville","toaster","willow","xpro2","nofilter"];


		// Trigger photo take


		document.getElementById("snap").addEventListener("click", function() {
			var canvas = document.getElementById('canvas');
			var canvas2=document.createElement('canvas');
			var context = canvas.getContext('2d');
			var ctx=canvas2.getContext('2d');

			$('.carousel-inner-render').html("");
			// Elements for taking the snapshot
			var video = document.getElementById('video');
			var height=$('#video').css('height').replace(/[^\d.-]/g, '');

			var width=$('#video').css('width').replace(/[^\d.-]/g, '');
			console.log(height,width);

			canvas.height=height;
			canvas.width=width;

			canvas2.height=height;
			canvas2.width=width;
			// context.filter=getComputedStyle(canvas).getPropertyValue('filter');
			ctx.drawImage(video, 0,0,width, height);

			for (i in effects){
				console.log(canvas,canvas.className);

				canvas.className = effects[i];
				context.filter=getComputedStyle(canvas).getPropertyValue('filter');
				context.drawImage(canvas2, 0,0,width, height);

				var image = new Image();
				image.id = "pic"+i;
				image.src = canvas.toDataURL("image/png");
				image.className="rounded";


				if(i==0){
						$('.carousel-inner-render').append(`
					    <div id="can`+i+`" class="carousel-item c-filter w-auto m-0 active no-opacity">
					    	<div class="carousel-caption d-none d-md-block caption-uppercase caption-effect">
						    	<h5>`+effects[i]+`</h5>
						  	</div>
					    </div>
				    `);


				}else{
					$('.carousel-inner-render').append(`
					    <div id="can`+i+`" class="carousel-item c-filter m-0 w-auto no-opacity">
					    	<div class="carousel-caption d-none d-md-block caption-uppercase caption-effect">
						    	<h5>`+effects[i]+`</h5>
						  	</div>
					    </div>
				    `);
				}
				document.getElementById('can'+i).appendChild(image);

			}
			$('canvas').css('display','none')
		});



		// snap click modal trigger
		$('#snap').on('click',function(e){
			$('.modal').modal('hide');

			$('.modal-photo').modal('show');
		})




		// file input
		function readURL(input) {
		  	if (input.files && input.files[0]) {
			    var reader = new FileReader();

			    reader.onload = function(e) {
			    	// $('#blah').attr('src', e.target.result);
		    		var image=new Image();
				 	// image.className="w-100"
					image.onload = function() {
					 	onImageLoad(image);
					}

				 	image.src = e.target.result;
				 	// console.log(image)
			    }

		    	reader.readAsDataURL(input.files[0]);
		  	}

		  	$('.modal').modal('hide');
		  	var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
			ctx.clearRect(0,0,0,0);

			$('.carousel-inner-render').html("");
			$('.modal-photo').modal('show');
		}




		$("#photoUp").change(function() {
		  readURL(this);
		});
		var onImageLoad = function(img) {
			var canvas = document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
			// canvas.className="w-100"

		  	canvas.width = img.width;
		  	canvas.height = img.height;

		  	for (i in effects){
				console.log(canvas,canvas.className);

				canvas.className = effects[i] + " w-100 h-50";
				ctx.filter=getComputedStyle(canvas).getPropertyValue('filter');
				// context.drawImage(canvas2, 0,0,width, height);
				ctx.drawImage(img, 0, 0);
				var image = new Image();
				image.id = "pic"+i;
				image.src = canvas.toDataURL("image/png");
				image.className="rounded w-100 h-50";


				if(i==0){
						$('.carousel-inner-render').append(`
					    <div id="can`+i+`" class="carousel-item c-filter w-auto m-0 active no-opacity">
					    	<div class="carousel-caption d-none d-md-block caption-uppercase caption-effect">
						    	<h5>`+effects[i]+`</h5>
						  	</div>
					    </div>
				    `);


				}else{
					$('.carousel-inner-render').append(`
					    <div id="can`+i+`" class="carousel-item c-filter m-0 w-auto no-opacity">
					    	<div class="carousel-caption d-none d-md-block caption-uppercase caption-effect">
						    	<h5>`+effects[i]+`</h5>
						  	</div>
					    </div>
				    `);
				}
				document.getElementById('can'+i).appendChild(image);

			}
			$('canvas').css('display','none')

		// file input ends here

		  	// console.log(canvas, ctx)
		}
		$(document).on('click','.heart',function(e){
			e.preventDefault();
		})
		$(document).on('dblclick','.heart',function(e){
			var post_id=$(this).data('post')
			var user_id=$(this).data('user')
			var like=$('.likes-'+post_id)
			var elem=$(this)
			e.preventDefault();
			if($(this).children().hasClass('heart-active')){
				$.ajax({
					url:'/profile/post/unlike/'+post_id+'/'+user_id,
					type:'GET',
					dataType:'JSON',
					success:function(data){
						console.log(data)
						elem.children().removeClass('heart-active')
						elem.children().attr('data-prefix','far')
						like.html(parseInt(like.html())-1)

					}
				})

			}else{
				$.ajax({
					url:'/profile/post/like/'+post_id+'/'+user_id,
					type:'GET',
					dataType:'JSON',
					success:function(data){
						console.log(data)
						elem.children().addClass('heart-active')
						elem.children().attr('data-prefix','fas')
						like.html(parseInt(like.html())+1)
					}
				})

			}

		})

		$('#photo-upload').on('click',function(e){

			e.preventDefault()
			var src=$('.c-filter.active img').attr('src')
			console.log(src)
			var photo=document.getElementById('photo-input')
			console.log(photo)
			photo.value=src
<!--			$('#photo-input').val()-->
			$('#form-photo').submit();
			console.log($('.c-filter.active'))
		});

		$(document).on('keypress','.comment',function(e) {

			var elem=$(this)
			var val=elem.val();
			var post_id=elem.data('post-id');
			var user_id=elem.data('user-id');
			if(e.which == 13) {
			e.preventDefault();
				$.ajax({
					url:'/profile/comment',
					type:'post',
					dataType:'json',
					data:{
						csrfmiddlewaretoken:'{{ csrf_token }}',
						comment:val,
						post_id:post_id,
						user_id:user_id,
					},
					success:function(data){
						elem.val('')
						if(data.data.success){
							$('.no-comment-'+post_id).remove();
							$('.comment-'+post_id).prepend(`<div class="img-post-comment">
									<a href="/profile/${user_id}" class="d-inline">{{ user.username }}</a>
									<p class="d-inline">${val}</p>
								</div>`)
						}

					}
				})
			}
		});
	</script>

	<script>

		$('.likes-text').on('click',function(e){
            e.preventDefault();
            var id=$(this).data('id');
            $.ajax({
                url:'/profile/like/'+id,
                dataType:'JSON',
                type:'GET',
                success:function(data){
                    console.log(data)
                    $('.modal-body-render').html(data.html)
                    $('.modal-render .modal-title').html('Follower')
                    $('.modal-render .modal-dialog').removeClass('modal-xl').addClass('modal-lg').addClass('h-50');
                    $('.modal-render .modal-content').addClass('overflow-auto').addClass('h-100')
                    $('.modal-render').modal('show');

                }
            })
        })
	</script>
{% block scripts %}{% endblock %}

</body>
</html>
